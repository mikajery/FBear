var Product = function(el) {
  var description  = el.find('[data-product=description]'),
      opener       = el.find('[data-product-toggle=description]'),
      _descInitH   = description.height(),
      media        = el.find('[data-product-media]'),
      mediaTypes   = ['360', 'video', 'pan'],
      videoContainer = el.find('.media[data-product-media]').filter('[data-product-media=video]'),
      videoContent = videoContainer.html(),
      mediaClose   = el.find('[data-product-dismiss=media]'),
      cover        = el.find('[data-product-cover]'),
      content      = el.find('[data-product=content]'),
      loading      = el.find('[data-product=loading]')
  ;

  var img = new Image();

  content.hide();

  img.onload = function() {
    console.log(img.src);
    cover.css({
      backgroundImage: 'url(' + img.src + ')'
    });  

    loading.fadeOut();
    
    el.addClass('loaded');
    content.fadeIn(function() {
      
    });
  }

  img.src = cover.attr('data-product-cover');

  

  var toggleDescription = function(show) {
    if (show)
    {
      description.addClass('active');
      description.height(el.height()*3/4);
      description.animate({
        marginTop: -1 * (description.height() - _descInitH + 40)
      });
    }
    else
    {
      description.animate({
        marginTop: 0, 
      }, function() {
        description.removeClass('active');
        description.height(_descInitH);
      });
    }
  };

  var togglePanorama = function(stop) {
    var pan = media.filter('.media[data-product-media=pan]'),
        image = pan.find('img'),
        _x = 0,
        _y = 0,
        _l = 0,
        _t = 0,
        timeout = false
    ;

    setInterval(function() {
      _l += 0.1;
      pan.scrollLeft(_l);
    })

    $('body')
      .on('mousedown', function(e) {
        _x  = e.pageX;
        _y  = e.pageY;
        _l = pan.scrollLeft();
        _t = pan.scrollTop();

        clearTimeout(timeout);

        $('body').on('mousemove', function(e) {
          var _dX = _x - e.pageX,
              _dY = _y - e.pageY
          ;

          pan.scrollLeft(_l + _dX);
          pan.scrollTop(_t + _dY);          
        });

        e.preventDefault();
        return false;
      })
      .on('mouseup', function() {
        $('body').off('mousemove');
        scrollPan();
      });
  };

  var toggle360 = function() {

    var wrap = media.filter('.media[data-product-media=360]'),
        items = wrap.find('[data-threesixty]'),
        viewer = media.find('[data-type=viewer]')
    ;

    if (wrap.data('_threesixty')) return

    var getViewer = function() {
      var div = $('<div>');
      viewer.empty().append(div);
      return div;
    };

    var toggleItem = function(item) {
      items.removeClass('active');
      item.addClass('active');

      showThreeSixty(window[item.data('threesixty')]);
    };

    var showThreeSixty = function(frames) {
      getViewer().spritespin({
        width     : 600,
        height    : 400,
        resolutionX      : 600,
        resolutionY      : 400,
        sizeX     : 600,
        sizeY     : 400,
        frames    : frames.length,
        behavior  : "drag", // "hold"
        module    : "360",
        sense     : -1,
        source    : frames,
        animate   : true,
        loop      : true,
        frameWrap : true,
        frameStep : 1,
        frameTime : 30,
        enableCanvas : true
      });
    }

    items.click(function() {
      toggleItem($(this));
    });

    if (0 == items.filter('.active').size())
      items.first().trigger('click');

    wrap.data('_threesixty', this);
  };

  var clearVideoContainer = function() {
    videoContainer.empty();
    videoContainer.html(videoContent);
  };

  var toggleMedia = function(type) {
    $.each(mediaTypes, function(i, k) {
      el.removeClass('show-' + k);
    });

    clearVideoContainer();

    if (media) {
      el.addClass('show-' + type);

      if ('pan' == type)
        togglePanorama();
      else if ('360' == type)
        toggle360();
    }
  };

  opener.click(function() {
    toggleDescription(!description.hasClass('active'));
  });

  media.filter('li').click(function() {
    if (!$(this).hasClass('active'))
    {
      media.removeClass('active');
      $(this).addClass('active');
      toggleMedia($(this).data('product-media'));
    }
  });

  mediaClose.click(function() {
    media.removeClass('active');
    toggleMedia(false);
  });
};

$(function() {
  $('[data-action=product]').each(function() {
    new Product($(this));
  });
});